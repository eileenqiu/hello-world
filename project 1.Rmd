## Simulation study
## different sample size
# Set parameters
set.seed(1113)
n <- 1000  # number of observations, we take 20,100,1000
beta0 <- 0.5  # intercept
beta1 <- 1.5  # coefficient for X1
beta2 <- -1   # coefficient for X2

# Simulate predictor variables
X1 <- runif(n, min = 0, max = 1)  # uniform distribution
X2 <- rnorm(n)                    # normal distribution

# Calculate linear predictor
eta <- beta0 + beta1 * X1 + beta2 * X2

# Apply logistic function
prob <- 1 / (1 + exp(-eta))

# Generate binary response variable
Y <- rbinom(n, size = 1, prob = prob)

# Combine data into a data frame
simulated_data <- data.frame(Y, X1, X2)

# Fit the original logistic regression model
m1 <- glm(Y ~ X1 + X2, data = simulated_data, family = "binomial")
summary1<-summary(m1)$coefficients
# Calculate the original Wald statistic for X1
original_wald <- summary1[2,1]/summary1[2,2]
# p value
original_pval<-2*pnorm(abs(original_wald),lower.tail=F)
# coefficient for X1
original_coef<-summary1[2,1]

summary(m1)

# confidence intervals
lower<-original_coef-1.96*summary1[2,2]
higher<-original_coef+1.96*summary1[2,2]
lower
higher

# Set up permutation test
#set.seed(2000)  # For reproducibility
n_perm <- 10000  # Number of permutations
count_extreme<-0

for (i in 1:n_perm) {
  # Permute the response variable
  permuted_Y <- sample(simulated_data$Y)
  # Fit the original logistic regression model
  m2 <- glm(permuted_Y ~ simulated_data$X1 + simulated_data$X2, family = "binomial",control=list(maxit=100))
  summary2<-summary(m2)$coefficients
  # The coefficient for X1
  perm_coef <- summary2[2,1]
  # Calculate the permuted Wald statistic for X1
  #perm_wald <- summary2[2,1]/summary2[2,2]
  # Check if the permuted Wald statistic is as extreme as the original
  if (abs(perm_coef) >= abs(original_coef)) {
    count_extreme <- count_extreme + 1
  }
}

# Calculate p-value
p_value <- count_extreme / n_perm
p_value

# nonparametric bootstrap
# Number of bootstrap replications
n_bootstraps <- 10000
count_extreme<-0
boot_CI<-data.frame("coef"=rep(0,n_bootstraps))
# Bootstrap procedure
#set.seed(1999)  # For reproducibility
for (i in 1:n_bootstraps) {
  boot_eta<-beta0+0*X1+beta2*X2
  boot_prob <- 1 / (1 + exp(-boot_eta))
  # Create a bootstrap sample with replacement
  bootstrap_sample <-rbinom(n, size = 1, prob = boot_prob)
  
  # Fit model to the bootstrap sample
  m3 <- glm(bootstrap_sample ~ simulated_data$X1 + simulated_data$X2, family = "binomial",control=list(maxit=100))
  
  summary3<-summary(m3)$coefficients
  # The coefficient for X1
  boot_wald<-summary3[2,1]/summary3[2,2]
  if (abs(boot_wald) >= abs(original_wald)) {
    count_extreme <- count_extreme + 1
  }
}

# Calculate p-value
p_value <- count_extreme / n_bootstraps
p_value

# nonparametric bootstrap CI(different)
# Number of bootstrap replications
n_bootstraps <- 10000
count_extreme<-0
boot_CI<-data.frame("coef"=rep(0,n_bootstraps))
# Bootstrap procedure
#set.seed(1999)  # For reproducibility
for (i in 1:n_bootstraps) {
  boot_eta<-beta0+beta1*X1+beta2*X2
  boot_prob <- 1 / (1 + exp(-boot_eta))
  # Create a bootstrap sample with replacement
  bootstrap_sample <-rbinom(n, size = 1, prob = boot_prob)
  
  # Fit model to the bootstrap sample
  m3 <- glm(bootstrap_sample ~ simulated_data$X1 + simulated_data$X2, family = "binomial",control=list(maxit=100))
  summary3<-summary(m3)$coefficients
  # The coefficient for X1
  boot_coef<-summary3[2,1]
  boot_CI[i,1]<-boot_coef
}

# confidence interval
bootci<-quantile(boot_CI[,1],c(0.025,0.975))
bootci

# correlated data,sample size is 120
## Simulation study
## different sample size
# Set parameters
set.seed(1113)
n <- 120  # number of observations, we take 20,100,1000
beta0 <- 0.5  # intercept
beta1 <- 1.5  # coefficient for X1
beta2 <- -1   # coefficient for X2

# Simulate predictor variables
X1 <- runif(n, min = 0, max = 1)  # uniform distribution
X2_1 <- rnorm(n)
X2 <- rnorm(X1,sd=1) # normal distribution

# Calculate linear predictor
eta <- beta0 + beta1 * X1 + beta2 * X2

# Apply logistic function
prob <- 1 / (1 + exp(-eta))

# Generate binary response variable
Y <- rbinom(n, size = 1, prob = prob)

# Combine data into a data frame
simulated_data <- data.frame(Y, X1, X2)

# Fit the original logistic regression model
m1 <- glm(Y ~ X1 + X2, data = simulated_data, family = "binomial")
summary1<-summary(m1)$coefficients
# Calculate the original Wald statistic for X1

original_wald <- summary1[2,1]/summary1[2,2]
# p value
original_pval<-2*pnorm(abs(original_wald),lower.tail=F)
# coefficient for X1
original_coef<-summary1[2,1]
summary(m1)

# confidence intervals
lower<-original_coef-1.96*summary1[2,2]
higher<-original_coef+1.96*summary1[2,2]
lower
higher

# Set up permutation test
#set.seed(2000)  # For reproducibility
n_perm <- 10000  # Number of permutations
count_extreme<-0
for (i in 1:n_perm) {
  # Permute the response variable
  permuted_Y <- sample(simulated_data$Y)
  # Fit the original logistic regression model
  m2 <- glm(permuted_Y ~ simulated_data$X1 + simulated_data$X2, family = "binomial",control=list(maxit=100))
  summary2<-summary(m2)$coefficients
  # The coefficient for X1
  perm_coef <- summary2[2,1]
  # Calculate the permuted Wald statistic for X1
  #perm_wald <- summary2[2,1]/summary2[2,2]
  # Check if the permuted Wald statistic is as extreme as the original
  if (abs(perm_coef) >= abs(original_coef)) {
    count_extreme <- count_extreme + 1
  }
}

pval<-count_extreme/n_perm
pval

#bootstrap
# nonparametric bootstrap
# Number of bootstrap replications
n_bootstraps <- 10000
count_extreme<-0
# Bootstrap procedure
#set.seed(1999)  # For reproducibility
for (i in 1:n_bootstraps) {
  boot_eta<-beta0+0*X1+beta2*X2
  boot_prob <- 1 / (1 + exp(-boot_eta))
  # Create a bootstrap sample with replacement
  bootstrap_sample <-rbinom(n, size = 1, prob = boot_prob)
  
  # Fit model to the bootstrap sample
  m3 <- glm(bootstrap_sample ~ simulated_data$X1 + simulated_data$X2, family = "binomial",control=list(maxit=100))
  
  summary3<-summary(m3)$coefficients

# The coefficient for X1
  boot_wald<-summary3[2,1]/summary3[2,2]
  if (abs(boot_wald) >= abs(original_wald)) {
    count_extreme <- count_extreme + 1
  }
}

boot_pval<-count_extreme/n_bootstraps
boot_pval

# nonparametric bootstrap CI(different)
# Number of bootstrap replications
n_bootstraps <- 10000
count_extreme<-0
boot_CI<-data.frame("coef"=rep(0,n_bootstraps))
# Bootstrap procedure
#set.seed(1999)  # For reproducibility
for (i in 1:n_bootstraps) {
  boot_eta<-beta0+beta1*X1+beta2*X2
  boot_prob <- 1 / (1 + exp(-boot_eta))
  # Create a bootstrap sample with replacement
  bootstrap_sample <-rbinom(n, size = 1, prob = boot_prob)
  
  # Fit model to the bootstrap sample
  m3 <- glm(bootstrap_sample ~ simulated_data$X1 + simulated_data$X2, family = "binomial",control=list(maxit=100))
  
  summary3<-summary(m3)$coefficients
  # The coefficient for X1
  boot_coef<-summary3[2,1]
  boot_CI[i,1]<-boot_coef
}

# confidence interval
bootci<-quantile(boot_CI[,1],c(0.025,0.975))
bootci

## case study
data<-read.csv("C:/Users/dell/Desktop/cardio_data_processed.csv")
data<-na.omit(data)

data$smoke<-as.factor(data$smoke)
data$alco<-as.factor(data$alco)
data$active<-as.factor(data$active)

model1<-glm(cardio~age+weight+ap_hi+smoke+alco+active,data=data,family="binomial")
summary(model1)

original_coef<-6.509e-02
# Set up permutation test
#set.seed(2000)  # For reproducibility
n_perm <- 1000  # Number of permutations
count_extreme<-0

for (i in 1:n_perm) {
  # Permute the response variable
  permuted_Y <- sample(data$cardio)
  # Fit the original logistic regression model
  model2 <- glm(permuted_Y ~ data$age+data$weight+data$ap_hi+data$smoke+data$alco+data$active, family = "binomial",control=list(maxit=100))
  summary2<-summary(model2)$coefficients
  # The coefficient for X1
  perm_coef <- summary2[4,1]
  # Calculate the permuted Wald statistic for X1
  #perm_wald <- summary2[2,1]/summary2[2,2]
  # Check if the permuted Wald statistic is as extreme as the original
  if (abs(perm_coef) >= abs(original_coef)) {
    count_extreme <- count_extreme + 1
  }
}

# Calculate p-value
p_value <- count_extreme / n_perm
p_value
